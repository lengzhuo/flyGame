var Sprite=laya.display.Sprite,Handler=laya.utils.Handler,Loader=laya.net.Loader,Animation=laya.display.Animation,Rectangle=laya.maths.Rectangle,Event=laya.events.Event,Pool=laya.utils.Pool,Browser=laya.utils.Browser,Stat=laya.utils.Stat,SoundManager=laya.media.SoundManager;!function(){function e(){this.bg1=null,this.bg2=null,e.__super.call(this),this.init()}Laya.class(e,"BackGround",laya.display.Sprite);var t=e.prototype;t.init=function(){this.bg1=new Sprite,this.bg1.loadImage("res/background.png"),this.addChild(this.bg1),this.bg2=new Sprite,this.bg2.loadImage("res/background.png"),this.bg2.pos(0,-852),this.addChild(this.bg2),Laya.timer.frameLoop(1,this,this.onLoop)},t.onLoop=function(){this.y+=1,852<=this.bg1.y+this.y&&(this.bg1.y-=1704),852<=this.bg2.y+this.y&&(this.bg2.y-=1704)}}(),function(){function s(){s.__super.call(this),this.body=null,this.type=null,this.camp=0,this.hp=0,this.speed=0,this.hitRadius=0,this.shootType=0,this.shootInterval=500,this.shootTime=Browser.now()+100,this.action=null,this.heroType=0}Laya.class(s,"Role",laya.display.Sprite);var e=s.prototype;s.cached=!1,e.init=function(e,t,o,a,i,n){this.type=e,this.camp=t,this.hp=o,this.speed=a,this.hitRadius=i,this.heroType=n,s.cached||(s.cached=!0,Animation.createFrames(["war/hero_fly1.png","war/hero_fly2.png"],"hero_fly"),Animation.createFrames(["war/hero_down1.png","war/hero_down2.png","war/hero_down3.png","war/hero_down4.png"],"hero_down"),Animation.createFrames(["war/enemy1_fly1.png"],"enemy1_fly"),Animation.createFrames(["war/enemy1_down1.png","war/enemy1_down2.png","war/enemy1_down3.png","war/enemy1_down4.png"],"enemy1_down"),Animation.createFrames(["war/enemy2_fly1.png"],"enemy2_fly"),Animation.createFrames(["war/enemy2_down1.png","war/enemy2_down2.png","war/enemy2_down3.png","war/enemy2_down4.png"],"enemy2_down"),Animation.createFrames(["war/enemy2_hit.png"],"enemy2_hit"),Animation.createFrames(["war/enemy3_fly1.png","war/enemy3_fly2.png"],"enemy3_fly"),Animation.createFrames(["war/enemy3_down1.png","war/enemy3_down2.png","war/enemy3_down3.png","war/enemy3_down4.png","war/enemy3_down5.png","war/enemy3_down6.png"],"enemy3_down"),Animation.createFrames(["war/enemy3_hit.png"],"enemy3_hit"),Animation.createFrames(["war/bullet1.png"],"bullet1_fly"),Animation.createFrames(["war/ufo1.png"],"ufo1_fly"),Animation.createFrames(["war/ufo2.png"],"ufo2_fly")),this.body||(this.body=new Animation,this.body.interval=50,this.addChild(this.body),this.body.on(laya.events.Event.COMPLETE,this,this.onPlayComplete)),this.playAction("fly")},e.onPlayComplete=function(){"down"==this.action?(this.body.stop(),this.visible=!1):"hit"==this.action&&this.playAction("fly")},e.playAction=function(e){this.action=e,this.body.play(0,!0,this.type+"_"+this.action);var t=this.body.getBounds();this.body.pos(-t.width/2,-t.height/2)}}(),function(){function e(){e.__super.call(this),this.pauseBtn.on(laya.events.Event.CLICK,this,this.onPauseBtnClick)}Laya.class(e,"GameInfo",ui.GameInfoUI);var t=e.prototype;t.reset=function(){this.infoLabel.text="",this.hp(5),this.level(0),this.score(0)},t.onPauseBtnClick=function(e){e.stopPropagation(),this.infoLabel.text="",gameInstance.pause(),Laya.stage.once(laya.events.Event.CLICK,this,this.onStageClick)},t.onStageClick=function(e){this.infoLabel.text="",gameInstance.resume()},t.hp=function(e){this.hpLabel.text="HP:"+e},t.level=function(e){this.levelLabel.text="Level:"+e},t.score=function(e){this.scoreLabel.text="Score:"+e}}(),function(){function e(){this.roleBox=null,this.gameInfo=null,this.hero=null,this.bulletPos=[[0],[-15,15],[-30,0,30],[-45,-15,15,45]],this.level=0,this.score=0,this.levelUpScore=0,this.bulletLevel=0,this.radius=[18,33,80],Laya.init(480,852),Laya.stage.scaleMode="showall",Laya.stage.alignH="center",Laya.stage.screenMode="vertical",this.bg=new BackGround,Laya.stage.addChild(this.bg),Laya.loader.load("res/atlas/war.json",Handler.create(this,this.onLoaded),null,Loader.ATLAS)}Laya.class(e,"Game");var t=e.prototype;t.onLoaded=function(){this.roleBox=new Sprite,Laya.stage.addChild(this.roleBox),this.gameInfo=new GameInfo,this.gameInfo.infoLabel.text="点击这里开始游戏",Laya.stage.addChild(this.gameInfo),this.hero=new Role,this.roleBox.addChild(this.hero),this.gameInfo.infoLabel.once(Event.CLICK,this,this.restart)},t.restart=function(){this.score=0,this.level=0,this.levelUpScore=0,this.bulletLevel=0,this.gameInfo.reset(),this.hero.init("hero",0,5,0,30,0),this.hero.pos(240,700),this.hero.shootType=1,this.hero.shootInterval=500,this.hero.visible=!0;for(var e=this.roleBox.numChildren-1;-1<e;e--){var t=this.roleBox.getChildAt(e);t!=this.hero&&(t.removeSelf(),t.visible=!0,Pool.recover("role",t))}this.resume()},t.resume=function(){Laya.stage.on(laya.events.Event.MOUSE_MOVE,this,this.onMouseMove),Laya.timer.frameLoop(1,this,this.onLoop)},t.pause=function(){Laya.timer.clear(this,this.onLoop),Laya.stage.off(Event.MOUSE_OVER,this,this.onMouseMove)},t.onLoop=function(){for(var e=this.roleBox.numChildren-1;-1<e;e--){var t=this.roleBox.getChildAt(e);if(t&&t.speed&&(t.y+=t.speed,(1e3<t.y||!t.visible||1==t.heroType&&t.y<-20)&&(t.removeSelf(),t.visible=!0,Laya.Pool.recover("role",t))),0<t.shootType){var o=Laya.Browser.now();if(o>t.shootTime){t.shootTime=o+t.shootInterval;for(var a=this.bulletPos[t.shootType-1],i=0;i<a.length;i++){var n=Pool.getItemByClass("role",Role);n.init("bullet1",t.camp,1,-4-t.shootType-Math.floor(this.level/15),1,1),n.pos(t.x+a[i],t.y-t.hitRadius-10),this.roleBox.addChild(n)}SoundManager.playSound("res/sound/bullet.mp3")}}}for(e=this.roleBox.numChildren-1;0<e;e--){var s=this.roleBox.getChildAt(e);if(!(s.hp<1))for(var h=e-1;-1<h;h--)if(s.visible){var r=this.roleBox.getChildAt(h);if(0<r.hp&&s.camp!=r.camp){var l=s.hitRadius+r.hitRadius;Math.abs(s.x-r.x)<l&&Math.abs(s.y-r.y)<l&&(this.lostHp(s,1),this.lostHp(r,1),this.score++,this.gameInfo.score(this.score),this.score>this.levelUpScore&&(this.level++,this.gameInfo.level(this.level),this.levelUpScore+=5*this.level))}}}this.hero.hp<1&&(SoundManager.playSound("res/sound/game_over.mp3"),Laya.timer.clear(this,this.onLoop),this.gameInfo.infoLabel.text="GameOver，分数："+this.score+"\n点击这里重新开始。",this.gameInfo.infoLabel.once(Event.CLICK,this,this.restart),console.log("Game over!"));var y=this.level<30?2*this.level:60,p=Math.floor(this.level/6),m=Math.floor(this.level/8),d=Math.floor(this.level/10);Laya.timer.currFrame%(80-y)==0&&this.createEnemy(0,2+d,3+p,1),Laya.timer.currFrame%(150-2*y)==0&&this.createEnemy(1,1+d,2+p,2+2*m),Laya.timer.currFrame%(900-4*y)==0&&this.createEnemy(2,1,1+p,10+6*m)},t.lostHp=function(e,t){if(e.hp-=t,2===e.heroType)this.bulletLevel++,this.hero.shootType=Math.min(Math.floor(this.bulletLevel/2)+1,4),this.hero.shootInterval=400-16*(20<this.bulletLevel?20:this.bulletLevel),e.visible=!1,SoundManager.playSound("res/sound/achievement.mp3");else if(3===e.heroType)this.hero.hp++,10<this.hero.hp&&(this.hero.hp=10),this.gameInfo.hp(this.hero.hp),e.visible=!1,SoundManager.playSound("res/sound/achievement.mp3");else if(0<e.hp)e.playAction("hit");else if(0<e.heroType)e.visible=!1;else if("hero"!=e.type&&Laya.SoundManager.playSound("res/sound/"+e.type+"_down.mp3"),e.playAction("down"),"enemy3"==e.type){var o=Math.random()<.7?2:3,a=Pool.getItemByClass("role",Role);a.init("ufo"+(o-1),e.camp,1,1,15,o),a.pos(e.x,e.y),this.roleBox.addChild(a)}e==this.hero&&this.gameInfo.hp(e.hp)},t.onMouseMove=function(){this.hero.pos(Laya.stage.mouseX,Laya.stage.mouseY)},t.createEnemy=function(e,t,o,a){for(var i=0;i<t;i++){var n=Pool.getItemByClass("role",Role);n.init("enemy"+(e+1),1,a,o,this.radius[e]),n.pos(400*Math.random()+40,200*-Math.random()-100),this.roleBox.addChild(n)}}}();var gameInstance=new Game;